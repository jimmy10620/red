<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>è‡ªå·±ç´…åŒ…è‡ªå·±æ±ºå®š</title>

<style>
html,body{
  margin:0;
  width:100%;
  height:100%;
  overflow:hidden;
  font-family:system-ui,-apple-system;
}
body{
  background:linear-gradient(180deg,#ffecd2,#fcb69f);
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
}
h1{margin:8px 0;}
.hint{opacity:.85;margin-bottom:10px;font-size:16px;}

input{
  padding:10px;
  border-radius:12px;
  border:none;
  width:70%;
  text-align:center;
  font-size:18px;
}

.mode-buttons{display:flex;gap:12px;margin:16px 0;}

button{
  padding:14px 30px;
  border:none;
  border-radius:999px;
  background:#e63946;
  color:white;
  font-size:18px;
}
button.secondary{background:#6c757d;}
button:disabled{background:#aaa;}

.digits{
  display:none;
  font-size:72px;
  letter-spacing:18px;
  font-weight:bold;
  margin:20px 0;
}

#topButtonGroup{display:flex;gap:12px;margin-top:10px;}
#bottomButtonGroup{margin-top:20px;}

#resetBtn,#shareBtn{display:none;}
.preview img{max-width:85vw;border-radius:16px;margin-top:16px;}
</style>
</head>

<body>

<h1>ğŸ§§ è‡ªå·±ç´…åŒ…è‡ªå·±æ±ºå®š</h1>
<div class="hint" id="hint">è¼¸å…¥åå­— â†’ é¸æ–¹å‘</div>

<input id="nameInput" placeholder="è¼¸å…¥åå­—ï¼ˆå¯ç©ºç™½ï¼‰">

<div class="mode-buttons" id="mode">
  <button onclick="selectMode('high')">å¾è¬ä½é–‹å§‹</button>
  <button onclick="selectMode('low')" class="secondary">å¾å€‹ä½é–‹å§‹</button>
</div>

<button id="startBtn" style="display:none;">é–‹å§‹æŠ½ç´…åŒ…</button>

<div class="digits" id="digits">ğŸ² ğŸ² ğŸ² ğŸ² ğŸ²</div>

<div id="topButtonGroup">
  <button id="rollBtn" style="display:none;">ğŸ² æ“²éª°å­</button>
  <button id="resetBtn" onclick="reset()">é‡æ–°ä¾†é</button>
</div>

<div class="preview" id="preview"></div>

<div id="bottomButtonGroup">
  <button id="shareBtn">ğŸ“¤ ä¸€éµåˆ†äº« LINE</button>
</div>

<script>
// ğŸ² éª°å­é»æ•¸å°æ‡‰ï¼ˆ1â€“6ï¼‰
const diceFace = ["","âš€","âš","âš‚","âšƒ","âš„","âš…"];
const posLabel=["è¬ä½","åƒä½","ç™¾ä½","åä½","å€‹ä½"];

let state={
  digits:[null,null,null,null,null],
  order:[],
  index:0,
  serial:"",
  time:""
};

let mode=null;
let imageBlob=null;

const hint=document.getElementById("hint");
const digitsEl=document.getElementById("digits");
const rollBtn=document.getElementById("rollBtn");
const resetBtn=document.getElementById("resetBtn");
const shareBtn=document.getElementById("shareBtn");
const preview=document.getElementById("preview");

function selectMode(m){
  mode=m;
  document.getElementById("startBtn").style.display="inline-block";
  hint.innerText=`æ–¹å‘å·²é¸ï¼š${m==='high'?'è¬ â†’ å€‹':'å€‹ â†’ è¬'}`;
}

document.getElementById("startBtn").onclick=()=>{
  state.time=new Date().toLocaleString();
  state.serial=`RP-${Date.now()}`;
  state.order=mode==='high'?[0,1,2,3,4]:[4,3,2,1,0];

  document.getElementById("mode").style.display="none";
  document.getElementById("startBtn").style.display="none";
  document.getElementById("nameInput").style.display="none";

  digitsEl.style.display="block";
  rollBtn.style.display="inline-block";
  hint.innerText=`æ“²éª°å­æ±ºå®šã€Œ${posLabel[state.order[state.index]]}ã€`;
  renderDigits();
};

// ğŸ¯ åªæœƒç”¢ç”Ÿ 1â€“6
function rand(){
  return Math.floor(Math.random()*6) + 1;
}

function renderDigits(){
  digitsEl.innerText = state.digits
    .map(d => d===null ? "ğŸ²" : diceFace[d])
    .join(" ");
}

rollBtn.onclick=()=>rollDice();

function rollDice(){
  rollBtn.disabled=true;
  const pos=state.order[state.index];
  let rolls=20;
  let delay=40;

  const timer=setInterval(()=>{
    state.digits[pos]=rand();
    renderDigits();
    rolls--;
    delay+=8;

    if(rolls<=0){
      clearInterval(timer);
      renderDigits(); // å®šæ ¼æˆéª°å­é»æ•¸
      state.index++;
      rollBtn.disabled=false;

      if(state.index<5){
        hint.innerText=`æ“²éª°å­æ±ºå®šã€Œ${posLabel[state.order[state.index]]}ã€`;
      }else{
        finish();
      }
    }
  },delay);
}

function finish(){
  rollBtn.style.display="none";
  hint.innerText="";

  // â³ åœç•™ 5 ç§’åœ¨éª°å­ç•«é¢
  setTimeout(()=>{
    digitsEl.style.display="none";
    generateImage(calcAmount());
    resetBtn.style.display="inline-block";
    shareBtn.style.display="inline-block";
  },2000);
}

function calcAmount(){
  return state.digits.reduce(
    (sum,val,i)=>sum + val*Math.pow(10,4-i),
    0
  );
}

function generateImage(amount){
  const c=document.createElement("canvas");
  c.width=900;c.height=1200;
  const x=c.getContext("2d");

  const g=x.createLinearGradient(0,0,0,1200);
  g.addColorStop(0,"#ffecd2");
  g.addColorStop(1,"#fcb69f");
  x.fillStyle=g;
  x.fillRect(0,0,900,1200);

  x.fillStyle="#000";
  x.textAlign="center";
  x.font="bold 52px system-ui";
  x.fillText("ğŸ§§ è‡ªå·±ç´…åŒ…è‡ªå·±æ±ºå®š",450,140);

  x.font="bold 150px system-ui";
  x.fillText(`ğŸ‰${amount.toLocaleString()} å…ƒğŸ‰`,450,550);

  x.font="28px system-ui";
  x.fillText(state.time,450,650);

  // æµ®æ°´å°åºè™Ÿ
  x.globalAlpha=.25;
  x.textAlign="right";
  x.fillText("ç´…åŒ…å‘½é‹ç³»çµ±",860,1120);
  x.fillText(state.serial,860,1160);

  const img=document.createElement("img");
  img.src=c.toDataURL();
  preview.innerHTML="";
  preview.appendChild(img);

  c.toBlob(b=>imageBlob=b);
}

shareBtn.onclick=async()=>{
  if(!imageBlob) return;
  const f=new File([imageBlob],"redpacket.png",{type:"image/png"});
  if(navigator.canShare && navigator.canShare({files:[f]})){
    await navigator.share({files:[f]});
  }else{
    alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ä¸€éµåˆ†äº«ï¼Œè«‹é•·æŒ‰åœ–ç‰‡");
  }
};

function reset(){
  location.reload();
}
</script>

</body>
</html>
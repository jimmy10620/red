<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>è‡ªå·±ç´…åŒ…è‡ªå·±æ±ºå®š</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ç´…åŒ…å‘½é‹">

<style>
body{
  margin:0;
  height:100vh;
  background:linear-gradient(180deg,#ffecd2,#fcb69f);
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  font-family:system-ui,-apple-system;
  text-align:center;
}
h1{margin-bottom:6px;}
.hint{font-size:17px;opacity:.85;margin-bottom:10px;}
.digits{font-size:38px;letter-spacing:14px;margin:18px 0;font-weight:bold;}
input{font-size:18px;padding:10px 14px;border-radius:12px;border:none;width:70%;margin-bottom:14px;text-align:center;}
.mode-buttons{display:flex;gap:16px;margin-bottom:16px;}
button{font-size:20px;padding:14px 34px;border:none;border-radius:999px;background:#e63946;color:white;}
button.secondary{background:#6c757d;}
button:disabled{background:#aaa;}
button:active{transform:scale(.96);}
.result{margin-top:18px;font-size:28px;font-weight:bold;display:none;}
.preview img{margin-top:16px;max-width:90vw;border-radius:16px;}
#startBtn{font-size:20px;padding:12px 28px;border-radius:12px;margin-bottom:16px;background:#f77; color:white;}

/* ä¸Šæ–¹æŒ‰éˆ•å€ï¼šæŠ½æ•¸+é‡æ–°ä¾†é */
#topButtonGroup{
  display:flex;
  gap:12px;
  margin-top:16px;
  justify-content:center;
}
/* ä¸‹æ–¹åˆ†äº«æŒ‰éˆ• */
#bottomButtonGroup{
  display:flex;
  justify-content:center;
  margin-top:24px;
}
#resetBtn{display:none;}
#shareBtn{display:none;}
</style>
</head>
<body>

<h1>ğŸ§§ è‡ªå·±ç´…åŒ…è‡ªå·±æ±ºå®š</h1>
<div class="hint" id="hint">è¼¸å…¥åå­— â†’ é¸æ–¹å‘</div>
<input id="nameInput" placeholder="è¼¸å…¥åå­—ï¼ˆå¯ç©ºç™½ï¼‰">

<div class="mode-buttons" id="mode">
  <button onclick="selectMode('high')">å¾è¬ä½é–‹å§‹</button>
  <button onclick="selectMode('low')" class="secondary">å¾å€‹ä½é–‹å§‹</button>
</div>

<button id="startBtn" style="display:none;">é–‹å§‹æŠ½ç´…åŒ…</button>
<div class="digits" id="digits" style="display:none;">ï¼¿ ï¼¿ ï¼¿ ï¼¿ ï¼¿</div>

<!-- ä¸Šæ–¹æŒ‰éˆ•å€ -->
<div id="topButtonGroup">
  <button id="btn" onclick="nextDigit()" style="display:none;">æ±ºå®šä¸€å€‹æ•¸</button>
  <button id="resetBtn" onclick="reset()">é‡æ–°ä¾†é</button>
</div>

<div class="result" id="result"></div>
<div class="preview" id="preview"></div>

<!-- ä¸‹æ–¹åˆ†äº«æŒ‰éˆ•å€ -->
<div id="bottomButtonGroup">
  <button id="shareBtn">ğŸ“¤ ä¸€éµåˆ†äº« LINE</button>
</div>

<script>
const posLabel=["è¬ä½æ•¸","åƒä½æ•¸","ç™¾ä½æ•¸","åä½æ•¸","å€‹ä½æ•¸"];
let state={name:"",order:null,digits:[0,0,0,0,0],index:0,locked:false,finished:false,time:null,serial:null};
let selectedMode=null;
let imageBlob=null;

const hint=document.getElementById("hint");
const digitsEl=document.getElementById("digits");
const resultEl=document.getElementById("result");
const btn=document.getElementById("btn");
const shareBtn=document.getElementById("shareBtn");
const resetBtn=document.getElementById("resetBtn");
const preview=document.getElementById("preview");

shareBtn.style.display="none";
resetBtn.style.display="none";

function selectMode(mode){
    selectedMode=mode;
    document.getElementById("startBtn").style.display="inline-block";
    hint.innerText=`æ–¹å‘å·²é¸ï¼š${mode==='high'?'è¬ä½â†’å€‹ä½':'å€‹ä½â†’è¬ä½'}ï¼Œé»é–‹å§‹æŠ½ç´…åŒ…`;
}

document.getElementById("startBtn").onclick=()=>{
    if(!selectedMode) return alert("è«‹å…ˆé¸æ–¹å‘ï¼");
    state.name=document.getElementById("nameInput").value.trim();
    state.time=new Date().toLocaleString();
    state.serial=`RP-${Date.now()}-${Math.floor(1000+Math.random()*9000)}`;
    state.index=0;
    state.order=selectedMode==='high'? [0,1,2,3,4]: [4,3,2,1,0];
    digitsEl.style.display="block";
    btn.style.display="inline-block";
    document.getElementById("nameInput").style.display="none";
    document.getElementById("mode").style.display="none";
    document.getElementById("startBtn").style.display="none";
    updateDigitsDisplay();
    hint.innerText=`æŒ‰ä¸‹ä¾†æ±ºå®šã€Œ${posLabel[state.order[state.index]]}ã€`;
};

function rand(){return Math.floor(Math.random()*7);}
function updateDigitsDisplay(){digitsEl.innerText=state.digits.map(n=>n===null?"ï¼¿":n).join(" ");}

function nextDigit(){
    btn.disabled=true;
    const pos=state.order[state.index];
    let count=0;
    const spin=setInterval(()=>{
        state.digits[pos]=rand();
        updateDigitsDisplay();
        count++;
        if(count>15){
            clearInterval(spin);
            state.index++;
            if(state.index<5){
                hint.innerText=`æŒ‰ä¸‹ä¾†æ±ºå®šã€Œ${posLabel[state.order[state.index]]}ã€`;
                btn.disabled=false;
            } else finish();
        }
    },50);
}

function finish(){
    const amount=state.digits[0]*10000+state.digits[1]*1000+state.digits[2]*100+state.digits[3]*10+state.digits[4];

    // éš±è—äº”ä½æ•¸
    digitsEl.style.display="none";
    btn.style.display="none";
    resultEl.style.display="none";

    hint.innerText="";

    generateImage(amount);

    // ä¸Šæ–¹é‡æ–°ä¾†éæŒ‰éˆ•ä¿æŒåŸä½
    resetBtn.style.display="inline-block";
    // åˆ†äº«æŒ‰éˆ•ä¸‹æ–¹é¡¯ç¤º
    shareBtn.style.display="inline-block";
}

function generateImage(amount){
    const canvas=document.createElement("canvas");
    canvas.width=900;canvas.height=1200;
    const ctx=canvas.getContext("2d");
    const grad=ctx.createLinearGradient(0,0,0,1200);
    grad.addColorStop(0,"#ffecd2");grad.addColorStop(1,"#fcb69f");
    ctx.fillStyle=grad;ctx.fillRect(0,0,900,1200);

    ctx.fillStyle="#000";ctx.textAlign="center";
    ctx.font="bold 52px system-ui";
    ctx.fillText("ğŸ§§ è‡ªå·±ç´…åŒ…è‡ªå·±æ±ºå®š",450,130);
    if(state.name) ctx.font="36px system-ui", ctx.fillText(`å°è±¡ï¼š${state.name}`,450,190);
    ctx.font="bold 140px system-ui"; // âœ… é‡‘é¡å­—é«”æ”¾å¤§
    ctx.fillText(`ğŸ‰${amount.toLocaleString()} å…ƒğŸ‰`,450,540);
    ctx.font="30px system-ui";
    ctx.fillText(`æ™‚é–“ï¼š${state.time}`,450,630);

    // æµ®æ°´å°åºè™Ÿ
    ctx.globalAlpha=0.25;
    ctx.font="28px system-ui";
    ctx.textAlign="right";
    ctx.fillText("ç´…åŒ…å‘½é‹ç³»çµ±",860,1120);
    ctx.fillText(state.serial,860,1160);
    ctx.globalAlpha=1;

    const img=document.createElement("img");
    img.src=canvas.toDataURL("image/png");
    preview.innerHTML="";preview.appendChild(img);

    canvas.toBlob(blob=>{
        imageBlob=blob;
    });
}

shareBtn.onclick=async()=>{
    if(!imageBlob) return;
    const file=new File([imageBlob],`redpacket-${state.serial}.png`,{type:"image/png"});
    if(navigator.canShare && navigator.canShare({files:[file]})){
        try{await navigator.share({title:"è‡ªå·±ç´…åŒ…è‡ªå·±æ±ºå®š",text:"å‘½é‹å·²å®šï¼Œç´…åŒ…é‡‘é¡å¦‚ä¸‹",files:[file]});}catch(e){}
    }else alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ä¸€éµåˆ†äº«ï¼Œè«‹é•·æŒ‰åœ–ç‰‡åˆ†äº«");
}

function reset(){
    location.reload();
}
</script>
</body>
</html>
